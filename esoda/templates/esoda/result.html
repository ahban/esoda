{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}ESODA | search result{% endblock %}

{% block head %}
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="{% static 'css/jquery.mCustomScrollbar.min.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}

  <div class="result-page">
    <div class="container">
      <div class="row">
        <div class="col-lg-2 col-md-2 col-sm-3">
          <div class="hidden-xs">
            {% if r.hasSyn or r.collocationList %}
              <div id="SidebarAffix" class="affix" data-spy="affix">
                <div class="panel-group">
                  <div class="tab-content CollapseColloc panel panel-default">
                    {% if r.collocationList %}
                      <div role="tabpanel" class="tab-pane fade in" id="CollocAll"></div>
                      {% for collocation in r.collocationList.cL %}
                        <div role="tabpanel" class="tab-pane fade usage-pane" id="{{ collocation.label }}"></div>
                      {% endfor %}
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endif %}
          </div>
        </div>

        <div class="col-lg-10 col-md-10 col-sm-9 result-main">
          <div class="panel-group" role="tablist" aria-multiselectable="true">
            {% if dictionary.explanationList %}
              {% include "esoda/dictionary_result.html" %}
            {% endif %}

            <div class="result-warning hidden">
              {% if not user.is_authenticated %}
                默认搜索领域为"<span>计算机全部领域</span>"，您尚未设置个人领域，<a href="#" data-toggle="modal" data-target="#ModalLogin">登录</a>
                进行个性化搜索
              {% else %}
                {% if r.domain|upper %}
                  当前个人领域为“<span>{{ r.domain|upper }}</span>”，在<a href="{% url 'authentication:domain' %}">其他个人领域</a>中搜索
                {% else %}
                  您尚未设置个人领域{{ r.domain|upper }}，<a href="{% url 'authentication:domain' %}">添加个人领域</a>进行个性化搜索
                {% endif %}
              {% endif %}
            </div>

            <div class="{% if not r.collocationList %}hidden{% endif %}">
              <div class="CollapseColloc row" role="tabpanel" aria-labelledby="HeadingColloc">
                <ul class="colList nav nav-tabs nav-tabs-collocation  col-lg-11 col-md-11 col-sm-11 col-xs-11"
                    role="tablist">
                  {% for collocation in r.collocationList.cL %}
                    <li role="presentation">
                      {% if forloop.counter == r.collocationList.index %}
                        <a href="#{{ collocation.label }}" class="colloc-sub-btn" role="tab" id="first"
                           data-toggle="tab" data="{{ collocation.title }}"
                           type="{{ collocation.type }}">{{ collocation.title }}</a>
                      {% endif %}
                      {% if forloop.counter != r.collocationList.index %}
                        <a href="#{{ collocation.label }}" class="colloc-sub-btn" role="tab"
                           data-toggle="tab" data="{{ collocation.title }}"
                           type="{{ collocation.type }}">{{ collocation.title }}</a>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
                <div class="col-lg-1 col-md-1 col-sm-1 col-xs-1 list-btn2">
                  <div id="colMore"><i class="fa fas fa-angle-down"></i></div>
                  <div id="colLess"><i class="fa fas fa-angle-up"></i></div>
                </div>
              </div>
            </div> <!-- panel-group -->

            <div id="Loading" class="result-table-cell center-align">
              <p><i class="fa fa-spinner fa-pulse fa-lg fa-fw"></i><span>正在加载</span></p>
            </div>

            <div id="SentenceResult"></div>

            <div id="Loading2" class="result-table-cell center-align">
              <p><i class="fa fa-spinner fa-pulse fa-lg fa-fw"></i><span>正在加载</span></p>
            </div>

            <div class="fix-right-xs">
              <div id="Feedback" class="affix feedback-affix" data-spy="affix">
                <div class="btn feedback" data-toggle="modal" data-target="#FeedbackModal">反馈</div>
              </div>
              <div id="BackToTopAffix" class="affix back-to-top-affix" data-spy="affix">
                <div class="btn back-to-top">
                  <p class="glyphicon glyphicon-chevron-up"></p>
                  <p>回到顶部</p>
                </div>
              </div>
            </div>

            <div class="modal fade" id="FeedbackModal">
              <div class="modal-dialog modal-sm modal-login-sm" id="feedback-modal">
                <div class="modal-content">
                  <div class="modal-header modal-login-header">
                    <img src="{% static 'img/logo.png' %}" class="modal-logo">
                    <h4>请提供您的意见与反馈</h4>
                  </div>
                  <div class="modal-body modal-login-body">
                    <form id="FeedbackForm" class="form-horizonal" method="post" action="{% url 'common:comment' %}">
                      {% csrf_token %}

                      <div>
                        <textarea form="FeedbackForm" name="comment" class="form-control"></textarea>
                      </div>

                      <input type="hidden" name="next" value="{{ next }}"/>
                      <input class="btn btn-primary" type="submit" value="提交反馈"/>
                    </form>
                  </div>
                </div>
              </div>
            </div>

            <div class="result-table-cell center-align">
              <span id="ManualLoad">点击加载更多</span>
            </div>

            <div id="ExampleEnd" class="result-table-cell center-align">
              <span>您已浏览完全部结果</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block script %}
  <script src="{% static 'js/esoda-result.js' %}?v={% now 'Ymd' %}"></script>
  <script src="{% static 'js/jquery.mousewheel.min.js' %}"></script>
  <script src="{% static 'js/jquery.mCustomScrollbar.min.js' %}"></script>
  <script>
    $(function () {
      $("#SidebarAffix").height($(window).height());
      // $("#SidebarAffix").height($(".result-page").height())
      var curSelectedUsage;
      var REF = '{{ ref }}';

      function searchAndFillSentences(params) {
        loadCount = 1;
        loading = 1;
        loaded = 0;
        $.get("{% url 'sentences' %}", params, function (data) {
          $('#Loading').hide();
          $('#ManualLoad').hide();
          $('#SentenceResult').html(data);
          // $('#SentenceResult').css('visibility', 'visible');
          $('#SentenceResult').animate({opacity: 1});
          var exampleNum = Number($("#ExampleNumber").text());
          if (exampleNum <= 10 && exampleNum > 0) {
            $('#ExampleEnd').show();
            loaded = 1;
          }
          loading = 0;
        });
      }

      colNum = ($(".colList").width() > 600) ? 4 : 3;
      $('.colList li:lt(' + colNum + ')').show();
      $(window).resize(function () {
        colNum = ($(".colList").width() > 600) ? 4 : 3;
        $('.colList li:lt(' + colNum + ')').show();
        $('.colList li').not(':lt(' + colNum + ')').hide();
      });
      $('#colMore').click(function () {
        $('.colList li').show();
        $('#colMore').hide();
        $('#colLess').show();
      });
      $('#colLess').click(function () {
        $('.colList li').not(':lt(' + colNum + ')').hide();
        $('#colLess').hide();
        $('#colMore').show();
      });

      // $('.not-limited').click(function (e) {
      //   e.preventDefault();
      //   if ($(this).attr('aria-expanded') == 'true') {
      //     return;
      //   }
      //   $("#ExampleEnd").hide();
      //   $("#ManualLoad").hide();
      //   $('#SentenceResult').empty();
      //   $('#Loading').show();

      //   var query = $(this).attr('data');

      //   searchAndFillSentences({t: query, ref: REF, dt: 0});
      // });

      // $('.not-limited').click();

      $('.colloc-sub-btn').click(function (e) {
        e.preventDefault();
        if ($(this).attr('aria-expanded') == 'true') {
          return;
        }
        var id = $(this).attr('href');
        var type = $(this).attr('type');
        var type0 = type.replace(/ \(.*\) /g, ' ');
        var i, dt;
        var ref = [];
        for (i = 0; i < type.split(' ').length; i++) {
          if (type.split(' ')[i] != type0.split(' ')[i]) break;
        }
        for (var j = 0, k = 0; j < type0.split(' ').length; j++) {
          if (type0.split(' ')[j] == '*') ref[j] = '*';
          else {
            ref[j] = REF.split(' ')[k];
            k = k + 1;
          }
        }
        if (i == 0) i = 1;
        dt = id.replace('#', '').split('_')[1];

        // $('#SentenceResult').css('visibility', 'hidden');

        // $('#SentenceResult').animate({ opacity: 0 }, function () {
        //   $('#Loading').show();
        // });
        // $('#ManualLoad').hide();
        // $("#ExampleEnd").hide();

        $.get("{% url 'collocation' %}", {t: type0, ref: ref.join(' '), i: i - 1, dt: dt}, function (data) {
          $(id).html(data);
          $(id + ' .colloc-result').mCustomScrollbar({
            theme: 'dark',
            scrollInertia: 0,
            mouseWheel: {preventDefault: true},
            autoHideScrollbar: true
          });
          $(id + ' .colloc-usage:eq(0)').click();
        });
      });

      $('#first').click();

      $('.CollapseColloc').on('click', '.colloc-usage', function (e) {
        e.preventDefault();
        if ($(this).attr('state') == 'selected') return;
        $("#ExampleEnd").hide();
        $('#ManualLoad').hide();
        // $('#SentenceResult').css('visibility', 'hidden');
        $('#SentenceResult').animate({opacity: 0}, function () {
          if (loading) $('#Loading').show();
        });

        $('.colloc-usage').removeAttr('state');
        $(this).attr('state', 'selected');

        // var collocQ = $(this).text().split(' ')[0].replace('...', ' ');
        var dt = $(this).parents('.tab-pane').attr('id').split('_')[1];
        var type = $(this).attr('lemma').replace(/ \(.*\)/, '');
        var i = type.replace('...', ' ... ').split(' ').indexOf('...') - 1;
        searchAndFillSentences({t: $(this).attr('lemma'), ref: $(this).attr('ref'), i: i, dt: dt});  // TODO: move to after animation
      });

      $('#FeedbackForm').submit(function (e) {
        e.preventDefault();
        var textarea = $(this).find('[name="comment"]');
        var msg = textarea.val().trim();
        if (msg) {
          $.post($(this).attr('action'), $(this).serialize(), function (r) {
            toastr.remove();
            toastr.success('反馈成功');
            textarea.val('');
            $('#FeedbackModal').modal('hide');
          });
        } else {
          toastr.remove();
          toastr.warning('请输入反馈内容');
        }
        textarea.focus();
      });

      // if ($('#Loading').is(':hidden')) {
      //     searchAndFillSentences({t: $(this).attr('data'), ref: $(this).attr('ref'), dt: 0});
      // }
    });
  </script>
{% endblock %}
