{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}ESODA | search result{% endblock %}

{% block head %}
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
{% endblock %}

{% block content %}

  <div class="result-page">
    <div class="container">
      <div class="row">
        <div class="col-sm-9 result-main">
          <div>

            <div class="result-warning">
              当前个人领域为"<span id="SearchDomain">{{ r.domain|upper }}</span>"，结果共<span id="CountUsage"></span>句例句，在其他<a {% if not user.is_authenticated %} href="#" data-toggle="modal" data-target="#ModalLogin" {% else %} href="{% url 'domain' %}" {% endif %}>个人领域</a>中搜索
            </div>

            <div class="panel-group" role="tablist" aria-multiselectable="true">
            {% if dictionary.explanationList %}
              {% include "esoda/dictionary_result.html" %}
            {% endif %}
            
            {% if r.synonymous %}
              <div class="panel panel-default">
                <div class="panel-collapse collapse in" role="tabpanel" aria-labelledby="HeadingUsage">
                  <ul class="nav nav-tabs nav-tabs-usage" id="UsageTab" role="tablist">
                    <!--li role="presentation">
                      <a href="#{{ usage_label }}" role="tab" data-toggle="tab">{{ usage_title }}</a>
                    </li-->
                    {% if r.synonymous %}
                    <li role="presentation" class="active">
                      <a href="#SynContent" role="tab" data-toggle="tab">{{ q }}&nbsp;&nbsp;同义表达</a>
                    </li>
                    {% endif %}
                    {% comment %}
                    {% if r.phrase %}
                    <li role="presentation">
                      <a href="#PhraseContent" role="tab" data-toggle="tab">{{ q }}&nbsp;&nbsp;常用短语</a>
                    </li>
                    {% endif %}
                    {% if r.commonColloc%}
                    <li role="presentation">
                      <a href="#ColContent" role="tab" data-toggle="tab">{{ q }}&nbsp;&nbsp;常用搭配</a>
                    </li>
                    {% endif %}
                    {% endcomment %}
                  </ul>
                  <div id="UsageContent" class="tab-content">
                    {% if r.synonymous %}
                    <div role="tabpanel" class="tab-pane fade active in" id="SynContent">
                      <div class="usage-panel-content">
                        {% for syn in r.synonymous %}
                        <a href="{% url 'esoda' %}?q={{ syn }}">{{ syn }}</a>&nbsp;&nbsp;
                        {% endfor %}
                      </div>
                    </div>
                    {% endif %}
                    {% if r.phrase %}
                    <div role="tabpanel" class="tab-pane fade" id="PhraseContent">
                      <div class="usage-panel-content">
                        {% for phr in r.phrase %}
                        <a href="{% url 'esoda' %}?q={{ phr }}">{{ phr }}</a>
                        {% if not forloop.last %},{% endif %}&nbsp;
                        {% endfor %}
                      </div>
                    </div>
                    {% endif %}
                    {% if r.commonColloc %}
                    <div role="tabpanel" class="tab-pane fade" id="ColContent">
                      <div class="usage-panel-content">
                        {% for ccol in r.commonColloc %}
                        <a href="{% url 'esoda' %}?q={{ ccol }}">{{ ccol }}</a>
                        {% if not forloop.last %},{% endif %}&nbsp;
                        {% endfor %}
                      </div>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div> <!-- usage panel -->
            {% endif %}

              <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="HeadingColloc">
                  <div class="panel-title-wrapper">
                    搭配
                    <span class="panel-subtitle">Collocation</span>
                    <a role="button" data-toggle="collapse" href="#CollapseColloc" aria-expanded="true" aria-controls="CollapseColloc" onclick="$.clickChevron(event);">
                      <span class="glyphicon glyphicon-chevron-up pull-right"></span>
                    </a>
                  </div>
                </div>
                <div id="CollapseColloc" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="HeadingColloc">
                  <ul class="nav nav-tabs nav-tabs-collocation pull-left" id="CollocationTab0" role="tablist">
                    <li role="presentation" class="active">
                        <a href="#CollocAll" class="not-limited" role="tab" data-toggle="tab">{{ q }}</a>
                    </li>
                  </ul>
                  <ul class="nav nav-tabs nav-tabs-collocation" id="CollocationTab" role="tablist">
                  {% if r.collocationList %}
                    {% for collocation in r.collocationList %}
                    <li role="presentation">
                      <a href="#{{ collocation.label }}" class="colloc-sub-btn" role="tab" data-toggle="tab" colloc="{{ collocation.colloc }}">{{ collocation.type }}</a>
                    </li>
                    {% endfor %}
                  {% endif %}
                  </ul>
                  <div id="CollocContent" class="tab-content">
                    <div role="tabpanel" class="tab-pane fade active in" id="CollocAll"></div>
                  {% if r.collocationList %}
                    {% for collocation in r.collocationList %}
                    <div role="tabpanel" class="tab-pane fade usage-pane" id="{{ collocation.label }}" colloc="{{ collocation.colloc }}"></div>
                    {% endfor %}
                  {% endif %}
                  </div>
                </div>
              </div> <!-- collocation panel -->

            </div> <!-- panel-group -->

            <div id="SentenceResult"></div>

            <div id="Loading" class="result-table-cell center-align">
              <p><i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i><span>正在加载</span></p>
            </div>

            <div id="ExampleEnd" class="result-table-cell center-align">
              <span>您已浏览完全部结果</span>
            </div>

          </div>
        </div>

        <div class="col-sm-3">
          <div class="hidden-xs">
            <div id="SidebarAffix" class="affix" data-spy="affix">
              <div class="panel-group">
                <div class="panel panel-default">
                  <div class="panel-heading">
                    大家都在搜
                  </div>
                  <ul class="list-group">
                  {% for related in suggestion.relatedList %}
                    <li class="list-group-item">
                      <a href="{% url 'esoda' %}?q={{ related }}">{{ related }}</a>
                    </li>
                  {% endfor %}
                  </ul>
                </div>

                <div class="panel panel-default">
                  <div class="panel-heading">
                    领域内热词
                  </div>
                  <ul class="list-group">
                  {% for hot in suggestion.hotList %}
                    <li class="list-group-item">
                      <a href="{% url 'esoda' %}?q={{ hot }}">{{ hot }}</a>
                    </li>
                  {% endfor %}
                  </ul>
                </div>
              </div>
            </div>
          </div>
          <div class="fix-right-xs">
            <div id="BackToTopAffix" class="affix back-to-top-affix" data-spy="affix">
              <div class="btn back-to-top">
                <p class="glyphicon glyphicon-chevron-up"></p>
                <p>回到顶部</p>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
{% endblock %}

{% block script %}
  <script src="{% static 'js/esoda-result.js' %}?v={% now 'Ymd' %}"></script>
  <script>
    $( function() {

      var curSelectedUsage;
      var REF = '{{ ref }}';

      $('#CollapseColloc').on('click', '.colloc-usage', function (e) {
        if ($(this).attr('state') == 'selected') return;
        e.preventDefault();
        $("#CollocationTab0 li").removeClass('active');
        $("#ExampleEnd").hide();
        $("#SentenceResult").html('<div class="result-table-cell center-align"><p><i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i><span>正在加载</span></p></div>');

        $(this).attr('state', 'selected');
        $(this).removeAttr('href');
        if (curSelectedUsage) {
          curSelectedUsage.attr('state', '');
          curSelectedUsage.attr('href', '#');
        }
        curSelectedUsage = $(this);

        // var collocQ = $(this).text().split(' ')[0].replace('...', ' ');
        var collocat = $(this).attr('colloc');
        loadCount = 1;
        loading = 1;
        loaded = 0;

        $.get("{% url 'sentences' %}", {ref: $(this).attr('ref'), colloc: collocat}, function(data) {
          $("#SentenceResult").html(data);
          if ($('#ExampleNumber').html() <= 10) {
            $('#ExampleEnd').show();
            loaded = 1;
          }
          loading = 0;
        });
      });

      $('#CollapseColloc').on('click', '.not-limited', function (e) {
        e.preventDefault();
        // if ($(this).parent().hasClass('acitve')) {
        //   return;
        // }
        $("#CollocationTab li").removeClass('active');
        $("#ExampleEnd").hide();
        $("#SentenceResult").html('<div class="result-table-cell center-align"><p><i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i><span>正在加载</span></p></div>');

        var collocQ = $(this).text();
        loadCount = 1;
        loading = 1;
        loaded = 0;

        // console.log(collocQ);
        $.get("{% url 'sentences' %}", {t: collocQ, ref: REF}, function(data) {
          $("#SentenceResult").html(data);
          $('#CountUsage').html($('#ExampleNumber').html());
          if ($('#ExampleNumber').html() <= 10) {
            $('#ExampleEnd').show();
            loaded = 1;
          }
          loading = 0;
        });
      });

      $('.not-limited').click();

      $('.colloc-sub-btn').click(function(e) {
        e.preventDefault();
        // if ($(this).parent().hasClass('active')) {
        //   return;
        // }
		var id = $(this).attr('href');
        var collocat = $(this).attr('colloc');
        
        $.get("{% url 'collocation' %}", {colloc: collocat}, function(data) {
          $(id).html(data);
          $(id + ' .colloc-usage:eq(0)').click();
        });
        
      })
    } );
  </script>
{% endblock %}
