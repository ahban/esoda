{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}ESODA | search result{% endblock %}

{% block head %}
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="{% static 'css/jquery.mCustomScrollbar.min.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}

  <div id="resultSearch">
    <form id="SearchForm" class="form-horizontal" role="search" action="{% url 'esoda' %}">
      <div class="input-group">
        <input type="text" id="SearchBox" class="navbar-search-box form-control result-search" placeholder="搜搭从这里开始" autocomplete="off" name="q" value="{{ q0 }}" onfocus="this.placeholder = ''" onblur="this.placeholder = '搜搭从这里开始'">
        <span class="input-group-btn">
          <button type="submit" class="btn-navbar-search">
            <span class="glyphicon glyphicon-search glyphicon-search-main"></span>
          </button>
        </span>
      </div>
      <div class="result-warning">
        当前个人领域为“<span>{{ r.domain|upper }}</span>” <a {% if not user.is_authenticated %} href="#" data-toggle="modal" data-target="#ModalLogin" {% else %} href="{% url 'authentication:domain' %}" {% endif %}>修改</a>
      </div>
    </form>
  </div>
  <div class="result-page">
    <div class="cover"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-2 col-md-2 col-sm-3">
          <div class="hidden-xs">
            <div id="SidebarAffix" class="affix" data-spy="affix">
              <div class="panel-group">
                <div class="panel panel-default">
                  <div class="panel-heading">
                    同义替换
                    <span id="loadMore" class="list-btn">+</span>
                    <span id="showLess" class="list-btn">-</span>
                  </div>
                  <ul class="list-group synList">
                    <li class="list-group-item">
                      <a data="{{ q }}">{{ q }}</a>
                    </li>
                    {% if r.synonymous %}
                      {% for syn in r.synonymous %}
                        <li class="list-group-item"><a href="{% url 'esoda' %}?q={{ syn }}">{{ syn }}</a></li>
                      {% endfor %}
                    {% endif %}
                  </ul>
                  <!-- <div class="panel-subheading"></div> -->
                  <script type="text/javascript">
                    for(var i=1;i<3;i++) {
                      document.write('<div class="panel-subheading">'+i+'. 单词'+i+'</div><ul class="list-group"><li class="list-group-item"><a>单词'+i+'替换词</a></li></ul>');
                      document.close();
                    }
                  </script>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-10 col-md-10 col-sm-9 result-main">
          <div>
            <div class="panel-group" role="tablist" aria-multiselectable="true">
            {% if dictionary.explanationList %}
              {% include "esoda/dictionary_result.html" %}
            {% endif %}
            
            {% if r.synonymous %}
              <div class="panel panel-default uncover-syn hidden">
                <div class="uncover panel-collapse collapse in" role="tabpanel" aria-labelledby="HeadingUsage">
                  <ul class="nav nav-tabs nav-tabs-usage" role="tablist">
                    {% if r.synonymous %}
                    <li role="presentation" class="active">
                      <a href="#SynContent" role="tab" data-toggle="tab">{{ q }}&nbsp;&nbsp;同义表达</a>
                    </li>
                    {% endif %}
                    {% comment %}
                    {% if r.phrase %}
                    <li role="presentation">
                      <a href="#PhraseContent" role="tab" data-toggle="tab">{{ q }}&nbsp;&nbsp;常用短语</a>
                    </li>
                    {% endif %}
                    {% if r.commonColloc %}
                    <li role="presentation">
                      <a href="#ColContent" role="tab" data-toggle="tab">{{ q }}&nbsp;&nbsp;常用搭配</a>
                    </li>
                    {% endif %}
                    {% endcomment %}
                  </ul>
                  <div id="UsageContent" class="tab-content row" style="margin-left: 10px">
                    {% if r.synonymous %}
                    <div role="tabpanel" class="tab-pane fade active in" id="SynContent">
                      <div class="usage-panel-content">
                        {% for syn in r.synonymous %}
                        <a href="{% url 'esoda' %}?q={{ syn }}">{{ syn }}</a>&nbsp;&nbsp;
                        {% endfor %}
                      </div>
                    </div>
                    {% endif %}
                    {% if r.phrase %}
                    <div role="tabpanel" class="tab-pane fade" id="PhraseContent">
                      <div class="usage-panel-content">
                        {% for phr in r.phrase %}
                        <a href="{% url 'esoda' %}?q={{ phr }}">{{ phr }}</a>
                        {% if not forloop.last %},{% endif %}&nbsp;
                        {% endfor %}
                      </div>
                    </div>
                    {% endif %}
                    {% if r.commonColloc %}
                    <div role="tabpanel" class="tab-pane fade" id="ColContent">
                      <div class="usage-panel-content">
                        {% for ccol in r.commonColloc %}
                        <a href="{% url 'esoda' %}?q={{ ccol }}">{{ ccol }}</a>
                        {% if not forloop.last %},{% endif %}&nbsp;
                        {% endfor %}
                      </div>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div> <!-- usage panel -->
            {% endif %}

            {# {% if r.collocationList %} #}
              <div class="uncover-colloc uncover-chi uncover-phrase {% if not r.collocationList %}hidden{% endif %}">
                <div id="CollapseColloc" class="uncover row" role="tabpanel" aria-labelledby="HeadingColloc">
                  <ul class="colList nav nav-tabs nav-tabs-collocation  col-lg-10 col-md-10 col-sm-11 col-xs-11" role="tablist">
                    <li role="presentation">
                      {# <a href="#" id="not-limited-btn" role="tab">全部搭配</a> #}
                      <a href="#CollocAll" role="tab" class="not-limited colloc-sub-btn" data-toggle="tab" data="{{ q }}">全部搭配</a>
                    </li>
                  {% for collocation in r.collocationList %}
                    <li role="presentation">
                      <a href="#{{ collocation.label }}" class="colloc-sub-btn" role="tab" data-toggle="tab" data="{{ collocation.title }}" type="{{ collocation.type }}">{{ collocation.title }}</a>
                    </li>
                  {% endfor %}
                  </ul>
                  <div class="tab-content hidden">
                    <div role="tabpanel" class="tab-pane fade in" id="CollocAll"></div>
                  {% for collocation in r.collocationList %}
                    <div role="tabpanel" class="tab-pane fade usage-pane" id="{{ collocation.label }}"></div>
                  {% endfor %}
                  </div>
                  <div class="col-lg-2 col-md-2 col-sm-1 col-xs-1 list-btn">
                    <span id="colMore">+</span>
                    <span id="colLess">-</span>
                  </div>
                </div>
              </div><!--  collocation panel -->
            {# {% endif %} #}

            </div> <!-- panel-group -->

            <div id="SentenceResult"></div>

            <div class="fix-right-xs">
              <div id="BackToTopAffix" class="affix back-to-top-affix" data-spy="affix">
                <div class="btn back-to-top">
                  <p class="glyphicon glyphicon-chevron-up"></p>
                  <p>回到顶部</p>
                </div>
              </div>
            </div>

            <div id="Loading" class="result-table-cell center-align">
              <p><i class="fa fa-spinner fa-pulse fa-lg fa-fw"></i><span>正在加载</span></p>
            </div>

            <div class="result-table-cell center-align">
              <span id="ManualLoad">点击加载更多</span>
            </div>

            <div id="ExampleEnd" class="result-table-cell center-align">
              <span>您已浏览完全部结果</span>
            </div>
          </div>
        </div>



      </div>
    </div>
  </div>
{% endblock %}

{% block script %}
  <script src="{% static 'js/esoda-result.js' %}?v={% now 'Ymd' %}"></script>
  <script src="{% static 'js/jquery.mousewheel.min.js' %}"></script>
  <script src="{% static 'js/jquery.mCustomScrollbar.min.js' %}"></script>
  <script>
    $( function() {

      var curSelectedUsage;
      var REF = '{{ ref }}';

      function searchAndFillSentences(params) {
        loadCount = 1;
        loading = 1;
        loaded = 0;
        $.get("{% url 'sentences' %}", params, function(data) {
          $('#Loading').hide();
          $('#ManualLoad').hide();
          $("#SentenceResult").html(data);
          if (Number($('#ExampleNumber').text()) <= 10) {
            $('#ExampleEnd').show();
            loaded = 1;
          }
          loading = 0;
        });
      }

      size_li = $(".synList li").size();
      x=3;
      $('.synList li:lt('+x+')').show();
      $('#loadMore').click(function () {
          x= (x+5 <= size_li) ? x+5 : size_li;
          $('.synList li:lt('+x+')').show();
          $('#loadMore').hide();
          $('#showLess').show();
      });
      $('#showLess').click(function () {
          x=(x-5<0) ? 3 : x-5;
          $('.synList li').not(':lt('+x+')').hide();
          $('#showLess').hide();
          $('#loadMore').show();
      });

      size_li_col = $(".colList li").size();
      y=3;
      $('.colList li:lt('+y+')').show();
      $('#colMore').click(function () {
          y= (y+6 <= size_li_col) ? y+6 : size_li_col;
          $('.colList li:lt('+y+')').show();
          $('#colMore').hide();
          $('#colLess').show();
      });
      $('#colLess').click(function () {
          y=(y-6<0) ? 3 : y-6;
          $('.colList li').not(':lt('+y+')').hide();
          $('#colLess').hide();
          $('#colMore').show();
      });

      $('.not-limited').click(function (e) {
        e.preventDefault();
        if ($(this).attr('aria-expanded') == 'true') {
          return;
        }
        $("#ExampleEnd").hide();
        $("#ManualLoad").hide();
        $('#SentenceResult').empty();
        $('#Loading').show();

        var query = $(this).attr('data');

        searchAndFillSentences({t: query, ref: REF, dt: 0});
      });

      $('.not-limited').click();

      $('.colloc-sub-btn').click(function(e) {
        e.preventDefault();
        if ($(this).attr('aria-expanded') == 'true') {
          return;
        }
        var id = $(this).attr('href');
        var type = $(this).attr('type');
        var type0 = type.replace(/ \(.*\) /g , ' ');
        var i, dt;
        var ref = [];
        for (i = 0; i < type.split(' ').length; i++) {
          if (type.split(' ')[i] != type0.split(' ')[i]) break;
        }
        for (var j = 0, k = 0; j < type0.split(' ').length; j++) {
          if (type0.split(' ')[j] == '*') ref[j] = '*';
          else {
            ref[j] = REF.split(' ')[k];
            k = k + 1;
          }
        }
        if (i == 0) i = 1;
        dt = id.replace('#', '').split('_')[1];

        $('#SentenceResult').empty();
        $('#Loading').show();
        $('#ManualLoad').hide();
        $("#ExampleEnd").hide();
        $.get("{% url 'collocation' %}", {t: type0, ref: ref.join(' ') , i: i - 1, dt: dt}, function(data) {
          $(id).html(data);
          $(id + ' .colloc-result').mCustomScrollbar({
            theme: 'dark',
            scrollInertia: 0,
            mouseWheel: {preventDefault:true}
          })
          $(id + ' .colloc-usage:eq(0)').click();
        });

      });

      $('#CollapseColloc').on('click', '.colloc-usage', function (e) {
        e.preventDefault();
        if ($(this).attr('state') == 'selected') return;
        $("#ExampleEnd").hide();
        $('#ManualLoad').hide();
        $('#SentenceResult').empty();
        $('#Loading').show();

        $('.colloc-usage').removeAttr('state');
        $(this).attr('state', 'selected');

        // var collocQ = $(this).text().split(' ')[0].replace('...', ' ');
        var dt = $(this).parents('.tab-pane').attr('id').split('_')[1];
        var type = $(this).text().replace(/ \(.*\)/, '');
        var i = type.replace('...', ' ... ').split(' ').indexOf('...') - 1;
        
        searchAndFillSentences({t: type.replace('...', ' '),  ref: $(this).attr('ref'), i: i, dt: dt});
      });
    } );
  </script>
{% endblock %}
