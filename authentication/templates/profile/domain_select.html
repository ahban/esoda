{% extends "profile_base.html" %}
{% load static %}
{% load i18n %}

{% block profile_content %}

<div id="field">
  <h4 class="personal-title"><strong>学术领域选择</strong></h4>
  <hr class="personal-line"/>
  <h5><strong>选择对口学术刊物以获得精准写作建议</strong><h5>
  <div class="form-group">
    <label for="input-search" class="sr-only">Search Tree:</label>
    <div class="search bar1" id="search-bar">
      <input type="text" id="input-search" placeholder="Type to search...">
      <button type="button" id="btn-search" ><span class="glyphicon glyphicon-search"></span></button>
    </div>
  </div>
  
  <!-- <div id="tree" class="pre-scrollable" style="max-height: 500px"></div> -->
  <form action="/domain/" method="post">
    {% csrf_token %}
    <div class="panel-group" id="accordion">
    {% for k in corpus %}
      <div class="panel-heading domain-panel-heading domain-block" >
        <h4 class="panel-title">
          <a data-toggle="collapse" data-parent="#accordion" 
             href="#collapse{{k.id}}" id="collapse_head{{k.id}}">
            {{k.text}}
          </a>
        </h4>
      </div>
      <div id="collapse{{k.id}}" class="panel-collapse collapse in">
        <div class="panel-body domain-nopadding domain-panel-body">
          <table>
            <tbody>
            {% for i in k.nodes %}
              <tr class="row">
                {%ifequal k.level 3 %}
                <td class="col-xs-4 col-sm-2 col-md-2 domain-level-1 domain-block domain-checkbox domain-border">
                  {{i.text}}
                  <input type="checkbox" value="{{i.id}}" id="check{{i.id}}" name="ids" onclick="aa({{i.id}})" {% if i.state.checked %} checked="checked" {% endif %} >
                </td>
                <td class="col-xs-8 col-sm-10 col-md-10 domain-block domain-nopadding domain-border">
                  <div class="domain-expand" onclick="bb({{i.id}})">
                    <div id="expand{{i.id}}"><span class="glyphicon glyphicon-chevron-down" ></span></div>
                  </div>
                  <div id="field{{i.id}}" class="domain-level-2" style="max-height:30px; overflow:hidden;">
                    {% for j in i.nodes %}
                      <label class="domain-item domain-checkbox"><input type="checkbox" value="{{j.id}}" id="check{{j.id}}" class="checkchild{{i.id}}" onclick="cc({{i.id}})" name="ids" {% if j.state.checked %} checked="checked" {% endif %}><span id="checktext{{j.id}}" title="{{j.text}}">{{j.text}}</span></label>
                    {% endfor %}
                  </div>
                </td>
                {% else %}
                <td class="col-xs-12 col-sm-12 col-md-12 domain-block domain-nopadding domain-border">
                  <div class="domain-expand" onclick="bb({{i.id}})">
                    <div id="expand{{i.id}}"><span class="glyphicon glyphicon-chevron-down" ></span></div>
                  </div>
                  <div id="field{{i.id}}" class="domain-level-2" style="max-height:30px; overflow:hidden;">
                    {% for j in i.nodes %}
                      <label class="domain-item domain-checkbox"><input type="checkbox" value="{{j.id}}" id="check{{j.id}}" class="checkchild{{i.id}}" name="ids" {% if j.state.checked %} checked="checked" {% endif %}><span id="checktext{{j.id}}" title="{{j.text}}">{{j.text}}</span></label>
                    {% endfor %}
                  </div>
                </td>
                {% endifequal %}
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}
    </div>
    <input class="btn" type="submit" value="提交"/>
  </form>
</div>
{% endblock %}
{% block script %}
<!-- <script src="{% static 'js/bootstrap-treeview.min.js' %}"></script> -->
<script>
  var last_result=[];
  var last_expand=[];
  var last_big=[];
  function aa(id){
    var temp =document.getElementById("check"+id).checked;
    var items = document.getElementsByClassName("checkchild"+id);
    for (var i = 0; i < items.length; ++i) {
        items[i].checked=temp;
    }
  }
  function bb(id){
    if(document.getElementById("expand"+id).innerHTML=="<span class=\"glyphicon glyphicon-chevron-down\"></span>"){
      document.getElementById("field"+id).style="max-height:500px; overflow:hidden;"
      document.getElementById("expand"+id).innerHTML="<span class=\"glyphicon glyphicon-chevron-up\"></span>"
    }else{
      document.getElementById("field"+id).style="max-height:30px; overflow:hidden;"
      document.getElementById("expand"+id).innerHTML="<span class=\"glyphicon glyphicon-chevron-down\"></span>"
    }
  }
  function cc(id) {
    var items = document.getElementsByClassName("checkchild"+id);
    var childStatus = false;
    for (var i = 0; i < items.length; ++i) {
        childStatus = (childStatus || items[i].checked);
    }
    document.getElementById("check"+id).checked = childStatus;
  }
  var search = function(e) {
    var pattern = $('#input-search').val();
    $.getJSON("{% url 'authentication:search' %}", {'target':pattern }, function(data){
      for(var i=0;i<last_expand.length;i++){ 
        document.getElementById("field"+last_expand[i]).style="max-height:25px; overflow:hidden;"
        document.getElementById("expand"+last_expand[i]).innerHTML="<span class=\"glyphicon glyphicon-chevron-down\"></span>"
      } 
      for(var i=0;i<last_result.length;i++){
        document.getElementById("checktext"+last_result[i]).style.color="#9b9b9b";
      }
      for(var i=0;i<last_big.length;i++){
        document.getElementById("collapse_head"+last_big[i]).style.color="#9b9b9b";
      }
      last_result=data.result;
      last_expand=data.expand;
      last_big=data.big;
      for(var i=0;i<data.expand.length;i++){ 
        document.getElementById("field"+data.expand[i]).style="max-height:500px; overflow:hidden;"
        document.getElementById("expand"+data.expand[i]).innerHTML="<span class=\"glyphicon glyphicon-chevron-up\"></span>"
      } 
      for(var i=0;i<data.result.length;i++){ 
        document.getElementById("checktext"+data.result[i]).style.color="red";
      }
      for(var i=0;i<data.big.length;i++){ 
        document.getElementById("collapse_head"+data.big[i]).style.color="#63B7E6";
      }
    });
  }

  $('#btn-search').on('click', search);
  $('#input-search').bind('keypress',function(event){
      if(event.keyCode == "13") search();
  });
</script>
  {% if messages %}
  <script>
  $(document).ready(function () {
  {% for message in messages %}
    toastr.success('{{ message }}. &nbsp;&nbsp;&nbsp;&nbsp;<a href="{% url 'esoda' %}">开始搜搭</a>');
  {% endfor %}
  });
  </script>
{% endif %}
{% endblock %}
